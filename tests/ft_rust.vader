Include: include/setup.vader

Execute (cargo skip non json line):
  new
  file build/lib.rs
  let cargo = neomake#makers#ft#rust#cargo()
  let cargo.exe = 'printf'
  let cargo.args = ['error: Could not compile `derive_more`.']

  call neomake#Make(1, [cargo])
  NeomakeTestsWaitForFinishedJobs

  AssertEqual [], getloclist(0)
  bwipe

Execute (cargo info message):
  new
  file build/lib.rs
  let cargo = NeomakeTestsGetMakerWithOutput('neomake#makers#ft#rust#cargo',
    \ '../tests/fixtures/rust/cargo_info.json')

  call neomake#Make(1, [cargo])
  NeomakeTestsWaitForFinishedJobs

  AssertEqual [], getloclist(0)
  bwipe

Execute (cargo error without span):
  new
  file build/lib.rs
  let cargo = NeomakeTestsGetMakerWithOutput('neomake#makers#ft#rust#cargo',
    \ '../tests/fixtures/rust/cargo_error_without_span.json')

  call neomake#Make(1, [cargo])
  NeomakeTestsWaitForFinishedJobs

  AssertEqual [], getloclist(0)
  bwipe

Execute (rust: cargo: uses directory with Cargo.toml as cwd):
  let maker = neomake#makers#ft#rust#cargo()
  AssertEqual maker.cwd, '%:p:h'

  let tempdir = tempname()
  let slash = neomake#utils#Slash()
  let subdir = tempdir . slash . 'subdir'
  call mkdir(subdir, 'p')
  let cargo_toml = tempdir . slash . 'Cargo.toml'
  call writefile([], cargo_toml)

  new
  exe 'lcd' subdir
  let maker = neomake#makers#ft#rust#cargo()
  AssertEqual maker.cwd, tempdir
  bwipe

Execute (rust: cargotest detect failures):
  new
  file build/lib.rs
  let cargotest = NeomakeTestsGetMakerWithOutput('neomake#makers#ft#rust#cargotest',
    \ '../test/fixtures/rust/cargotest_with_failures')

  call neomake#Make(1, [cargotest])
  NeomakeTestsWaitForFinishedJobs

  AssertEqual 1, len(getloclist(0))
  AssertEqual map(getloclist(0), 'v:val.text'),  [' unresolved import `self::tests`']
  bwipe

Execute (rust: cargotest: uses directory with Cargo.toml as cwd):
  let maker = neomake#makers#ft#rust#cargotest()
  AssertEqual maker.cwd, '%:p:h'

  let tempdir = tempname()
  let slash = neomake#utils#Slash()
  let subdir = tempdir . slash . 'subdir'
  call mkdir(subdir, 'p')
  let cargo_toml = tempdir . slash . 'Cargo.toml'
  call writefile([], cargo_toml)

  new
  exe 'lcd' subdir
  let maker = neomake#makers#ft#rust#cargotest()
  AssertEqual maker.cwd, tempdir
  bwipe
